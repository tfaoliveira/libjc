fn theta(reg u64[25] state) -> reg u64[25]
{
  inline int x y;
  reg u64[5] bc;
  reg u64 r temp;

  for x=0 to 5
  {
    bc[x]  = state[x];
    bc[x] ^= state[5 + x];
    bc[x] ^= state[10 + x];
    bc[x] ^= state[15 + x];
    bc[x] ^= state[20 + x];
  }

  for x=0 to 5
  {
    temp = bc[(x+4) % 5];
    _, _, r = #x86_ROL_64(bc[(x+1) % 5], 1);
    temp ^= r;
    for y=0 to 5
    {
      state[(y*5) + x] ^= temp;
    }
  }

  return state;
}

